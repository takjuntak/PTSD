pipeline {
    agent any
    stages {
        stage('Check Branch') {
            steps {
                script {
                    def targetBranch = env.gitlabTargetBranch ?: env.BRANCH_NAME
                    if (targetBranch != null && targetBranch != 'dev-be') {
                        currentBuild.result = 'ABORTED'
                        error("This pipeline only runs for merge requests to dev-be branch")
                    }
                }
            }
        }

        stage('CheckOut') {
            steps {
                echo 'Start CheckOut project...'
                git branch: 'dev-be',
                    credentialsId: 'account', // ğŸ”¥ Jenkinsì— ë“±ë¡í•œ GitLab ê³„ì • í¬ë¦¬ë´ì…œ ID
                    url: 'https://lab.ssafy.com/s12-final/S12P31D101.git' // ğŸ”¥ ë„¤ ë¦¬í¬ì§€í† ë¦¬ URLë¡œ ìˆ˜ì •
                sh '''
                    pwd
                    ls -R
                '''
                echo 'CheckOut finished!'
            }
        }

        stage('Build') {
            steps {
                echo 'Start building project...'
                dir('backend') {
                    sh '''
                        pwd
                        ls -R
                    '''
                    // FastAPIë‹ˆê¹Œ ë¹Œë“œ ë”°ë¡œ ì—†ìŒ (Springì²˜ëŸ¼ gradlew ë¹Œë“œí•  í•„ìš” ì—†ìŒ)
                }
                echo 'Build finished!'
            }
        }

        stage('Deploy') {
            steps {
                script {
                    dir('infra') {
                        // ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
                        sh "docker compose down || true"

                        // ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹œì‘
                        sh "docker compose build --no-cache"
                        sh "docker compose up -d"

                        echo 'Deploy finished!'
                    }
                }
            }
        }
    }
    post {
        success {
            echo 'Pipeline succeeded!'
        }
        failure {
            echo 'Pipeline failed!'
            dir('infra') {
                sh 'docker compose logs'
            }
        }
        always {
            echo 'Cleaning up workspace'
            cleanWs()
        }
    }
}
